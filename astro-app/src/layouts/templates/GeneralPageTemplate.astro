---
/**
 * GeneralPageTemplate.astro
 *
 * 一般頁面 Template
 * 適用：about_us, services, solutions, esg
 *
 * 佈局結構：
 * 1. Hero Banner
 * 2. Sections（按 yml 原始順序渲染 text/image/anchor）
 * 3. CTA
 */
import Layout from '../Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import HeroSection from '../../components/HeroSection.astro';
import AnchorSection from '../../components/AnchorSection.astro';
import TextSection from '../../components/TextSection.astro';
import ImageSection from '../../components/ImageSection.astro';
import CTASection from '../../components/CTASection.astro';
import type { PageContent, AioData, LayoutSection } from '../../utils/content';
import type { JsonLdItem } from '../../components/SEO.astro';

export interface Props {
  page: PageContent;
}

const { page } = Astro.props;
const { seo, layout, aio, content } = page;

// Breadcrumb - 讓組件根據 URL 自動生成（符合佈局分離原則）
const breadcrumbItems = undefined;

// JSON-LD
function buildJsonLd(aioData: AioData | undefined): JsonLdItem[] {
  if (!aioData) return [];
  const items: JsonLdItem[] = [];
  if (aioData.webpage) items.push({ type: 'WebPage', data: aioData.webpage });
  return items;
}

const jsonLdItems = buildJsonLd(aio);

// LCP & OG Image
const lcpImage = layout?.hero?.image ? {
  desktop: layout.hero.image.desktop,
  mobile: layout.hero.image.mobile
} : undefined;

const siteUrl = Astro.url.origin;
const DEFAULT_OG_IMAGE = '/assets/og-default.jpg';
const ogImage = seo.og_image
  ? (seo.og_image.startsWith('http') ? seo.og_image : `${siteUrl}${seo.og_image}`)
  : (layout?.hero?.image?.desktop ? `${siteUrl}${layout.hero.image.desktop}` : `${siteUrl}${DEFAULT_OG_IMAGE}`);

// 內容資料
const heroData = content?.hero || layout?.hero;

// 保持原始順序：取得所有非 CTA 的 sections
const allSections = layout?.sections?.filter((s: any) => s.type !== 'cta') || [];

// CTA 單獨處理（放最後）
const ctaData = content?.cta || layout?.sections?.find((s: any) => s.type === 'cta');
---

<Layout
  title={seo.title}
  description={seo.description}
  keywords={seo.keywords}
  jsonLd={jsonLdItems}
  lcpImage={lcpImage}
  ogImage={ogImage}
>
  <Header />

  <main class="page-main">
    <Breadcrumb items={breadcrumbItems} />

    <!-- 1. Hero Banner -->
    {heroData?.image && (
      <HeroSection
        image={heroData.image}
        overlay={heroData.overlay}
        height={heroData.height as 'full' | 'fixed' | 'auto'}
      />
    )}

    <!-- 2. All Sections（保持 yml 原始順序）-->
    {allSections.map((section: LayoutSection) => {
      if (section.type === 'text' && section.content) {
        return (
          <TextSection
            id={section.id}
            content={section.content}
            title={section.title}
            label={section.label}
          />
        );
      }
      if (section.type === 'image' && section.image_id) {
        return (
          <ImageSection image_id={section.image_id} display={section.display} />
        );
      }
      if (section.type === 'anchor') {
        return (
          <AnchorSection
            id={section.id}
            title={section.title || ''}
            description={section.description}
            cards={section.cards}
          />
        );
      }
      return null;
    })}

    <!-- 3. CTA -->
    {ctaData && (
      <CTASection
        title={ctaData.title || ''}
        description={ctaData.description}
        button_text={ctaData.button_text}
        button_link={ctaData.button_link}
        variant={ctaData.variant as 'primary' | 'secondary' | 'dark'}
      />
    )}
  </main>

  <Footer />
</Layout>

<style>
  .page-main {
    min-height: 100vh;
    padding-top: 64px;
  }
</style>
