---
/**
 * EventPageTemplate.astro
 *
 * 活動頁面固定佈局 Template
 * 適用：event_information, event_20251021, event_20251118 等
 *
 * 佈局結構：
 * 1. Hero Banner
 * 2. Carousel（活動輪播）或 Text（活動說明）
 * 3. CTA（報名按鈕）
 */
import Layout from '../Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import HeroSection from '../../components/HeroSection.astro';
import TextSection from '../../components/TextSection.astro';
import CarouselSection from '../../components/CarouselSection.astro';
import CTASection from '../../components/CTASection.astro';
import type { PageContent, AioData } from '../../utils/content';
import type { JsonLdItem } from '../../components/SEO.astro';

export interface Props {
  page: PageContent;
}

const { page } = Astro.props;
const { seo, layout, aio, content } = page;

// Breadcrumb
const breadcrumbItems = aio?.webpage?.breadcrumb?.itemListElement?.map((item: { name: string; item?: string }) => ({
  label: item.name,
  href: item.item
    ? (item.item.startsWith('http') ? new URL(item.item).pathname : item.item)
    : ''
})) || undefined;

// JSON-LD
function buildJsonLd(aioData: AioData | undefined): JsonLdItem[] {
  if (!aioData) return [];
  const items: JsonLdItem[] = [];
  if (aioData.webpage) items.push({ type: 'WebPage', data: aioData.webpage });
  if (aioData.event) items.push({ type: 'Event', data: aioData.event });
  return items;
}

const jsonLdItems = buildJsonLd(aio);

// LCP & OG Image
const lcpImage = layout?.hero?.image ? {
  desktop: layout.hero.image.desktop,
  mobile: layout.hero.image.mobile
} : undefined;

const siteUrl = Astro.url.origin;
const DEFAULT_OG_IMAGE = '/assets/og-default.jpg';
const ogImage = seo.og_image
  ? (seo.og_image.startsWith('http') ? seo.og_image : `${siteUrl}${seo.og_image}`)
  : (layout?.hero?.image?.desktop ? `${siteUrl}${layout.hero.image.desktop}` : `${siteUrl}${DEFAULT_OG_IMAGE}`);

// 內容資料
const heroData = content?.hero || layout?.hero;
const carouselData = content?.carousel || layout?.sections?.find((s: any) => s.type === 'carousel');
const textSections = content?.texts || layout?.sections?.filter((s: any) => s.type === 'text') || [];
const ctaData = content?.cta || layout?.sections?.find((s: any) => s.type === 'cta');
---

<Layout
  title={seo.title}
  description={seo.description}
  keywords={seo.keywords}
  jsonLd={jsonLdItems}
  lcpImage={lcpImage}
  ogImage={ogImage}
>
  <Header />

  <main class="page-main">
    <Breadcrumb items={breadcrumbItems} />

    <!-- 1. Hero Banner -->
    {heroData?.image && (
      <HeroSection
        image={heroData.image}
        overlay={heroData.overlay}
        height={heroData.height as 'full' | 'fixed' | 'auto'}
      />
    )}

    <!-- 2. Carousel（如有）-->
    {carouselData?.items && (
      <CarouselSection
        id={carouselData.id}
        label={carouselData.label}
        title={carouselData.title}
        description={carouselData.description}
        items={carouselData.items}
        autoplay={carouselData.autoplay}
        dots={carouselData.dots}
        arrows={carouselData.arrows}
      />
    )}

    <!-- 2b. Text Sections（如有）-->
    {textSections.map((section: any) => (
      <TextSection
        id={section.id}
        content={section.content}
        title={section.title}
        label={section.label}
      />
    ))}

    <!-- 3. CTA -->
    {ctaData && (
      <CTASection
        title={ctaData.title || ''}
        description={ctaData.description}
        button_text={ctaData.button_text}
        button_link={ctaData.button_link}
        variant={ctaData.variant as 'primary' | 'secondary' | 'dark'}
      />
    )}
  </main>

  <Footer />
</Layout>

<style>
  .page-main {
    min-height: 100vh;
    padding-top: 64px;
  }
</style>
