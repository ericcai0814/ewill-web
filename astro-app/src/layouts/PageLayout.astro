---
/**
 * PageLayout.astro
 *
 * 基礎頁面佈局（已簡化）
 *
 * 職責：
 * - 提供 HTML 骨架（Header, Main, Footer）
 * - 處理 SEO 和 JSON-LD
 * - 作為 TemplateRenderer 的 fallback
 *
 * 注意：
 * - 動態 section 渲染已移至各 Template
 * - 所有頁面應指定 template 欄位使用專屬 Template
 */
import Layout from './Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import PopupModal from '../components/PopupModal.astro';
import HeroSection from '../components/HeroSection.astro';
import { getAssetById } from '../utils/content';
import type { PageContent, AioData } from '../utils/content';
import type { JsonLdItem } from '../components/SEO.astro';

export interface Props {
  page: PageContent;
  showBreadcrumb?: boolean;
}

const { page, showBreadcrumb = true } = Astro.props;
const { seo, layout, aio } = page;

// 首頁不顯示 Breadcrumb
const shouldShowBreadcrumb = showBreadcrumb && page.slug !== 'index';

// 從 AIO 資料建立 Breadcrumb items（如有定義）
const breadcrumbItems = aio?.webpage?.breadcrumb?.itemListElement?.map((item: { name: string; item?: string }) => ({
  label: item.name,
  href: item.item
    ? (item.item.startsWith('http') ? new URL(item.item).pathname : item.item)
    : ''
})) || undefined;

// Popup 設定 (僅首頁)
let popupImage = null;
if (layout?.popup?.image_id) {
  const asset = await getAssetById(layout.popup.image_id);
  if (asset) {
    popupImage = {
      desktop: asset.variants.desktop,
      mobile: asset.variants.mobile,
      alt: asset.alt
    };
  }
}

// 建構 JSON-LD 資料
function buildJsonLd(aioData: AioData | undefined): JsonLdItem[] {
  if (!aioData) return [];

  const items: JsonLdItem[] = [];

  if (aioData.organization) items.push({ type: 'Organization', data: aioData.organization });
  if (aioData.website) items.push({ type: 'WebSite', data: aioData.website });
  if (aioData.webpage) items.push({ type: 'WebPage', data: aioData.webpage });
  if (aioData.faq && aioData.faq.length > 0) items.push({ type: 'FAQPage', data: { items: aioData.faq } });
  if (aioData.product) items.push({ type: 'Product', data: aioData.product });
  if (aioData.service) items.push({ type: 'Service', data: aioData.service });
  if (aioData.event) items.push({ type: 'Event', data: aioData.event });

  return items;
}

const jsonLdItems = buildJsonLd(aio);

// LCP Image for preload (Hero Banner)
const lcpImage = layout?.hero?.image ? {
  desktop: layout.hero.image.desktop,
  mobile: layout.hero.image.mobile
} : undefined;

// OG Image
const DEFAULT_OG_IMAGE = '/assets/og-default.jpg';
const siteUrl = Astro.url.origin;

function getOgImageUrl(): string {
  if (seo.og_image) {
    return seo.og_image.startsWith('http') ? seo.og_image : `${siteUrl}${seo.og_image}`;
  }
  if (layout?.hero?.image?.desktop) {
    return `${siteUrl}${layout.hero.image.desktop}`;
  }
  return `${siteUrl}${DEFAULT_OG_IMAGE}`;
}

const ogImage = getOgImageUrl();
---

<Layout
  title={seo.title}
  description={seo.description}
  keywords={seo.keywords}
  jsonLd={jsonLdItems}
  lcpImage={lcpImage}
  ogImage={ogImage}
>
  <Header />

  <main class="page-main">
    <!-- Breadcrumb -->
    {shouldShowBreadcrumb && <Breadcrumb items={breadcrumbItems} />}

    <!-- Hero Section -->
    {layout?.hero?.image && (
      <HeroSection
        image={layout.hero.image}
        overlay={layout.hero.overlay}
        height={layout.hero.height as 'full' | 'fixed' | 'auto'}
      />
    )}

    <!-- Fallback Notice -->
    <section class="fallback-notice">
      <div class="container">
        <p class="notice-text">
          ⚠️ 此頁面尚未指定 Template。請在 yml 中加入 <code>template:</code> 欄位。
        </p>
      </div>
    </section>

    <!-- Slot for custom content -->
    <slot />
  </main>

  <Footer />

  <!-- Popup Modal (首頁限定) -->
  {popupImage && layout?.popup && (
    <PopupModal
      image={popupImage}
      link={layout.popup.link}
      trigger={layout.popup.trigger as 'first_visit' | 'scroll' | 'time'}
    />
  )}
</Layout>

<style>
  .page-main {
    min-height: 100vh;
    padding-top: 64px;
  }

  .fallback-notice {
    padding: 40px 0;
    text-align: center;
  }

  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 24px;
  }

  .notice-text {
    font-size: 14px;
    color: var(--text-secondary);
    background: var(--bg-secondary);
    border: 1px dashed var(--border-color);
    border-radius: 8px;
    padding: 16px 24px;
    margin: 0;
  }

  .notice-text code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
  }
</style>
