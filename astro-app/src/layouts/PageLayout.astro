---
import Layout from './Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import PopupModal from '../components/PopupModal.astro';
import HeroSection from '../components/HeroSection.astro';
import TextSection from '../components/TextSection.astro';
import ImageSection from '../components/ImageSection.astro';
import CardListSection from '../components/CardListSection.astro';
import AnchorSection from '../components/AnchorSection.astro';
import FeatureGridSection from '../components/FeatureGridSection.astro';
import CTASection from '../components/CTASection.astro';
import ProductIntroSection from '../components/ProductIntroSection.astro';
import FeatureShowcaseSection from '../components/FeatureShowcaseSection.astro';
import TimelineSection from '../components/TimelineSection.astro';
import GallerySection from '../components/GallerySection.astro';
import ContactFormSection from '../components/ContactFormSection.astro';
import CarouselSection from '../components/CarouselSection.astro';
import { getAssetById } from '../utils/content';
import type { PageContent, LayoutSection, AioData } from '../utils/content';
import type { JsonLdItem } from '../components/SEO.astro';

export interface Props {
  page: PageContent;
  showBreadcrumb?: boolean;
}

const { page, showBreadcrumb = true } = Astro.props;
const { seo, layout, aio } = page;

// 首頁不顯示 Breadcrumb
const shouldShowBreadcrumb = showBreadcrumb && page.slug !== 'index';

// Popup 設定 (僅首頁)
let popupImage = null;
if (layout?.popup?.image_id) {
  const asset = await getAssetById(layout.popup.image_id);
  if (asset) {
    popupImage = {
      desktop: asset.variants.desktop,
      mobile: asset.variants.mobile,
      alt: asset.alt
    };
  }
}

// 建構 JSON-LD 資料
function buildJsonLd(aioData: AioData | undefined): JsonLdItem[] {
  if (!aioData) return [];

  const items: JsonLdItem[] = [];

  // Organization (僅首頁)
  if (aioData.organization) {
    items.push({
      type: 'Organization',
      data: aioData.organization
    });
  }

  // WebSite (僅首頁)
  if (aioData.website) {
    items.push({
      type: 'WebSite',
      data: aioData.website
    });
  }

  // WebPage (每頁)
  if (aioData.webpage) {
    items.push({
      type: 'WebPage',
      data: aioData.webpage
    });
  }

  // FAQ
  if (aioData.faq && aioData.faq.length > 0) {
    items.push({
      type: 'FAQPage',
      data: { items: aioData.faq }
    });
  }

  // Product (產品頁)
  if (aioData.product) {
    items.push({
      type: 'Product',
      data: aioData.product
    });
  }

  // Service (服務頁)
  if (aioData.service) {
    items.push({
      type: 'Service',
      data: aioData.service
    });
  }

  // Event (活動頁)
  if (aioData.event) {
    items.push({
      type: 'Event',
      data: aioData.event
    });
  }

  return items;
}

const jsonLdItems = buildJsonLd(aio);

// LCP Image for preload (Hero Banner)
const lcpImage = layout?.hero?.image ? {
  desktop: layout.hero.image.desktop,
  mobile: layout.hero.image.mobile
} : undefined;

// OG Image 優先順序：seo.og_image > hero.image.desktop > 預設圖片
const DEFAULT_OG_IMAGE = '/assets/og-default.jpg';
const siteUrl = Astro.site?.origin || 'https://www.ewill.com.tw';

function getOgImageUrl(): string {
  // 1. 優先使用 seo.og_image
  if (seo.og_image) {
    return seo.og_image.startsWith('http') ? seo.og_image : `${siteUrl}${seo.og_image}`;
  }
  // 2. 使用 Hero banner desktop 版
  if (layout?.hero?.image?.desktop) {
    return `${siteUrl}${layout.hero.image.desktop}`;
  }
  // 3. 使用預設圖片
  return `${siteUrl}${DEFAULT_OG_IMAGE}`;
}

const ogImage = getOgImageUrl();
---

<Layout
  title={seo.title}
  description={seo.description}
  keywords={seo.keywords}
  jsonLd={jsonLdItems}
  lcpImage={lcpImage}
  ogImage={ogImage}
>
  <Header />

  <main class="page-main">
    <!-- Breadcrumb -->
    {shouldShowBreadcrumb && <Breadcrumb />}

    <!-- Hero Section -->
    {layout?.hero?.image && (
      <HeroSection
        image={layout.hero.image}
        overlay={layout.hero.overlay}
        height={layout.hero.height as 'full' | 'fixed' | 'auto'}
      />
    )}

    <!-- Dynamic Sections -->
    {layout?.sections && layout.sections.map((section: LayoutSection) => {
      if (section.type === 'text' && section.content) {
        return (
          <TextSection
            id={section.id}
            content={section.content}
            title={section.title}
            label={section.label}
          />
        );
      }
      if (section.type === 'image' && section.image_id) {
        return (
          <ImageSection image_id={section.image_id} display={section.display} />
        );
      }
      if (section.type === 'card_list' && section.cards) {
        return (
          <CardListSection
            label={section.label}
            title={section.title || ''}
            description={section.description}
            columns={section.columns}
            layout_variant={section.layout_variant}
            cards={section.cards}
          />
        );
      }
      if (section.type === 'anchor' && section.cards && section.id) {
        return (
          <AnchorSection
            id={section.id}
            title={section.title || ''}
            description={section.description}
            cards={section.cards}
          />
        );
      }
      if (section.type === 'feature_grid' && section.features) {
        return (
          <FeatureGridSection
            label={section.label}
            title={section.title}
            columns={section.columns as 3 | 4}
            variant={section.variant as 'default' | 'icon' | 'minimal'}
            features={section.features}
          />
        );
      }
      if (section.type === 'cta' && section.button_text && section.button_link) {
        return (
          <CTASection
            title={section.title || ''}
            description={section.description}
            button_text={section.button_text}
            button_link={section.button_link}
            variant={section.variant as 'primary' | 'secondary' | 'dark'}
            align={section.align}
          />
        );
      }
      if (section.type === 'product_intro') {
        return (
          <ProductIntroSection
            label={section.label}
            title={section.title || ''}
            subtitle={section.subtitle}
            description={section.description || ''}
            align={section.align}
          />
        );
      }
      if (section.type === 'feature_showcase' && section.features) {
        return (
          <FeatureShowcaseSection
            label={section.label}
            title={section.title}
            layout={section.layout}
            features={section.features}
          />
        );
      }
      if (section.type === 'timeline' && section.events) {
        return (
          <TimelineSection
            label={section.label}
            title={section.title || ''}
            description={section.description}
            events={section.events}
            layout={section.layout as 'vertical' | 'horizontal'}
          />
        );
      }
      if (section.type === 'gallery' && section.images) {
        return (
          <GallerySection
            label={section.label}
            title={section.title}
            description={section.description}
            columns={section.columns as 2 | 3 | 4}
            gap={section.gap}
            images={section.images}
            lightbox={section.lightbox}
          />
        );
      }
      if (section.type === 'contact_form' && section.fields) {
        return (
          <ContactFormSection
            label={section.label}
            title={section.title || ''}
            fields={section.fields}
            button_text={section.button_text || '送出'}
          />
        );
      }
      if (section.type === 'carousel' && section.items) {
        return (
          <CarouselSection
            id={section.id}
            label={section.label}
            title={section.title}
            description={section.description}
            items={section.items}
            autoplay={section.autoplay}
            dots={section.dots}
            arrows={section.arrows}
            display={section.display}
          />
        );
      }
      return null;
    })}

    <!-- Slot for custom content -->
    <slot />
  </main>

  <Footer />

  <!-- Popup Modal (首頁限定) -->
  {popupImage && layout?.popup && (
    <PopupModal
      image={popupImage}
      link={layout.popup.link}
      trigger={layout.popup.trigger as 'first_visit' | 'scroll' | 'time'}
    />
  )}
</Layout>

<style>
  /* Vitesse Style: Consistent header height */
  .page-main {
    min-height: 100vh;
    padding-top: 64px; /* Fixed header height (h-16) */
  }
</style>
