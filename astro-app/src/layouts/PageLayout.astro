---
import Layout from './Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import PopupModal from '../components/PopupModal.astro';
import HeroSection from '../components/HeroSection.astro';
import TextSection from '../components/TextSection.astro';
import ImageSection from '../components/ImageSection.astro';
import CardListSection from '../components/CardListSection.astro';
import AnchorSection from '../components/AnchorSection.astro';
import AnchorNav from '../components/AnchorNav.astro';
import FeatureGridSection from '../components/FeatureGridSection.astro';
import CTASection from '../components/CTASection.astro';
import ProductIntroSection from '../components/ProductIntroSection.astro';
import FeatureShowcaseSection from '../components/FeatureShowcaseSection.astro';
import TimelineSection from '../components/TimelineSection.astro';
import GallerySection from '../components/GallerySection.astro';
import { getAssetById } from '../utils/content';
import type { PageContent, LayoutSection, AioData } from '../utils/content';
import type { JsonLdItem } from '../components/SEO.astro';

export interface Props {
  page: PageContent;
  showBreadcrumb?: boolean;
}

const { page, showBreadcrumb = true } = Astro.props;
const { seo, layout, aio } = page;

// 首頁不顯示 Breadcrumb
const shouldShowBreadcrumb = showBreadcrumb && page.slug !== 'index';

// Popup 設定 (僅首頁)
let popupImage = null;
if (layout?.popup?.image_id) {
  const asset = await getAssetById(layout.popup.image_id);
  if (asset) {
    popupImage = {
      desktop: asset.variants.desktop,
      mobile: asset.variants.mobile,
      alt: asset.alt
    };
  }
}

// 建構 JSON-LD 資料
function buildJsonLd(aioData: AioData | undefined): JsonLdItem[] {
  if (!aioData) return [];

  const items: JsonLdItem[] = [];

  if (aioData.organization) {
    items.push({
      type: 'Organization',
      data: aioData.organization
    });
  }

  if (aioData.website) {
    items.push({
      type: 'WebSite',
      data: aioData.website
    });
  }

  if (aioData.webpage) {
    items.push({
      type: 'WebPage',
      data: aioData.webpage
    });
  }

  if (aioData.faq && aioData.faq.length > 0) {
    items.push({
      type: 'FAQPage',
      data: { items: aioData.faq }
    });
  }

  return items;
}

const jsonLdItems = buildJsonLd(aio);

// AnchorNav 配置
const hasAnchors = layout?.anchors && layout.anchors.length > 0;
---

<Layout
  title={seo.title}
  description={seo.description}
  keywords={seo.keywords}
  jsonLd={jsonLdItems}
>
  <Header />

  <main class:list={['page-main', { 'page-main--with-anchors': hasAnchors }]}>
    <!-- Breadcrumb -->
    {shouldShowBreadcrumb && <Breadcrumb />}

    <!-- Hero Section -->
    {layout?.hero?.image && (
      <HeroSection image={layout.hero.image} />
    )}

    <!-- AnchorNav (側邊導航) -->
    {hasAnchors && (
      <div class="page-main__anchor-nav">
        <AnchorNav items={layout.anchors} position="sidebar" sticky={true} />
      </div>
    )}

    <!-- Dynamic Sections -->
    {layout?.sections && layout.sections.map((section: LayoutSection) => {
      if (section.type === 'text' && section.content) {
        return (
          <TextSection
            id={section.id}
            content={section.content}
            title={section.title}
            label={section.label}
          />
        );
      }
      if (section.type === 'image' && section.image_id) {
        return (
          <ImageSection image_id={section.image_id} />
        );
      }
      if (section.type === 'card_list' && section.cards) {
        return (
          <CardListSection
            label={section.label}
            title={section.title || ''}
            description={section.description}
            columns={section.columns}
            layout_variant={section.layout_variant}
            cards={section.cards}
          />
        );
      }
      if (section.type === 'anchor' && section.cards && section.id) {
        return (
          <AnchorSection
            id={section.id}
            title={section.title || ''}
            description={section.description}
            cards={section.cards}
          />
        );
      }
      if (section.type === 'feature_grid' && section.features) {
        return (
          <FeatureGridSection
            label={section.label}
            title={section.title}
            columns={section.columns as 3 | 4}
            variant={section.variant as 'default' | 'icon' | 'minimal'}
            features={section.features}
          />
        );
      }
      if (section.type === 'cta' && section.button_text && section.button_link) {
        return (
          <CTASection
            title={section.title || ''}
            description={section.description}
            button_text={section.button_text}
            button_link={section.button_link}
            variant={section.variant as 'primary' | 'secondary' | 'dark'}
            align={section.align}
          />
        );
      }
      if (section.type === 'product_intro') {
        return (
          <ProductIntroSection
            label={section.label}
            title={section.title || ''}
            subtitle={section.subtitle}
            description={section.description || ''}
            align={section.align}
          />
        );
      }
      if (section.type === 'feature_showcase' && section.features) {
        return (
          <FeatureShowcaseSection
            label={section.label}
            title={section.title}
            layout={section.layout}
            features={section.features}
          />
        );
      }
      if (section.type === 'timeline' && section.events) {
        return (
          <TimelineSection
            label={section.label}
            title={section.title || ''}
            description={section.description}
            events={section.events}
            layout={section.layout as 'vertical' | 'horizontal'}
          />
        );
      }
      if (section.type === 'gallery' && section.images) {
        return (
          <GallerySection
            label={section.label}
            title={section.title}
            description={section.description}
            columns={section.columns as 2 | 3 | 4}
            gap={section.gap}
            images={section.images}
            lightbox={section.lightbox}
          />
        );
      }
      return null;
    })}

    <!-- Slot for custom content -->
    <slot />
  </main>

  <Footer />

  <!-- Popup Modal (首頁限定) -->
  {popupImage && layout?.popup && (
    <PopupModal
      image={popupImage}
      link={layout.popup.link}
      trigger={layout.popup.trigger as 'first_visit' | 'scroll' | 'time'}
    />
  )}
</Layout>

<style>
  .page-main {
    min-height: 100vh;
    padding-top: 100px; /* Header height */
  }

  /* 帶有 AnchorNav 的頁面佈局 */
  .page-main--with-anchors {
    display: grid;
    grid-template-columns: 1fr;
  }

  .page-main__anchor-nav {
    display: none;
  }

  /* 桌機版 (≥1024px) 顯示側邊導航 */
  @media (min-width: 1024px) {
    .page-main--with-anchors {
      grid-template-columns: 220px 1fr;
      gap: 32px;
      max-width: 1440px;
      margin: 0 auto;
      padding-left: 24px;
      padding-right: 24px;
    }

    .page-main__anchor-nav {
      display: block;
      grid-row: 3; /* 在 breadcrumb 和 hero 之後 */
    }

    /* Hero 和 Breadcrumb 橫跨整個寬度 */
    .page-main--with-anchors > :global(.hero-section),
    .page-main--with-anchors > :global(.breadcrumb) {
      grid-column: 1 / -1;
    }
  }

  /* 平板 (545-1023px) 頂部水平導航 */
  @media (min-width: 545px) and (max-width: 1023px) {
    .page-main__anchor-nav {
      display: block;
      position: sticky;
      top: 74px;
      z-index: 10;
      background: #fff;
    }
  }

  /* 手機 (≤544px) 頂部水平導航 */
  @media (max-width: 544px) {
    .page-main__anchor-nav {
      display: block;
      position: sticky;
      top: 60px;
      z-index: 10;
      background: #fff;
    }
  }

  /* 平板 (≤921px) */
  @media (max-width: 921px) {
    .page-main {
      padding-top: 74px;
    }
  }

  /* 小手機 (≤544px) */
  @media (max-width: 544px) {
    .page-main {
      padding-top: 60px;
    }
  }
</style>
