---
export interface ContactField {
  name: string;
  label: string;
  placeholder?: string;
  required?: boolean;
  type?: 'text' | 'email' | 'tel' | 'textarea';
}

export interface Props {
  label?: string;
  title: string;
  fields: ContactField[];
  button_text: string;
}

const { label, title, fields, button_text } = Astro.props;

// Separate fields into grid (text inputs) and full-width (textarea)
const gridFields = fields.filter(f => f.type !== 'textarea');
const textareaFields = fields.filter(f => f.type === 'textarea');
---

<!-- Vitesse Style: Clean contact form with AJAX submission -->
<section class="py-12 md:py-16">
  <div class="container-wide">
    {label && (
      <span class="block text-xs font-medium text-[var(--accent)] uppercase tracking-wider mb-2 text-center">
        {label}
      </span>
    )}
    <h2 class="text-2xl md:text-3xl font-semibold text-[var(--text-primary)] mb-10 text-center">
      {title}
    </h2>

    <form id="contact-form" class="max-w-2xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
        {gridFields.map((field) => (
          <div class="flex flex-col">
            <label class="text-sm font-medium text-[var(--text-primary)] mb-2" for={field.name}>
              {field.label}
              {field.required && <span class="text-[var(--accent)]">*</span>}
            </label>
            <input
              type={(field.type as 'text' | 'email' | 'tel') || 'text'}
              id={field.name}
              name={field.name}
              placeholder={field.placeholder || ''}
              required={field.required}
              class="w-full px-4 py-3 text-sm
                     border border-[var(--border-color)] rounded-md bg-[var(--bg-primary)]
                     text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)]
                     transition-colors duration-200
                     focus:outline-none focus:border-[var(--accent)]"
            />
          </div>
        ))}
      </div>

      {textareaFields.map((field) => (
        <div class="flex flex-col mb-5">
          <label class="text-sm font-medium text-[var(--text-primary)] mb-2" for={field.name}>
            {field.label}
            {field.required && <span class="text-[var(--accent)]">*</span>}
          </label>
          <textarea
            id={field.name}
            name={field.name}
            placeholder={field.placeholder || ''}
            required={field.required}
            rows="5"
            class="w-full px-4 py-3 text-sm
                   border border-[var(--border-color)] rounded-md bg-[var(--bg-primary)]
                   text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)]
                   transition-colors duration-200 resize-y min-h-[120px]
                   focus:outline-none focus:border-[var(--accent)]"
          ></textarea>
        </div>
      ))}

      <!-- Status message -->
      <div id="form-status" class="mb-5 hidden">
        <div id="form-success" class="hidden p-4 rounded-md bg-green-50 border border-green-200">
          <p class="text-sm text-green-800"></p>
        </div>
        <div id="form-error" class="hidden p-4 rounded-md bg-red-50 border border-red-200">
          <p class="text-sm text-red-800"></p>
        </div>
      </div>

      <button type="submit" id="submit-btn" class="btn btn-primary w-full justify-center">
        <span id="btn-text">{button_text}</span>
        <span id="btn-loading" class="hidden">處理中...</span>
        <svg id="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
        <svg id="btn-spinner" class="hidden animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
          <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
        </svg>
      </button>
    </form>
  </div>
</section>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text') as HTMLSpanElement;
  const btnLoading = document.getElementById('btn-loading') as HTMLSpanElement;
  const btnIcon = document.getElementById('btn-icon') as SVGElement;
  const btnSpinner = document.getElementById('btn-spinner') as SVGElement;
  const formStatus = document.getElementById('form-status') as HTMLDivElement;
  const formSuccess = document.getElementById('form-success') as HTMLDivElement;
  const formError = document.getElementById('form-error') as HTMLDivElement;

  function setLoading(loading: boolean) {
    submitBtn.disabled = loading;
    btnText.classList.toggle('hidden', loading);
    btnLoading.classList.toggle('hidden', !loading);
    btnIcon.classList.toggle('hidden', loading);
    btnSpinner.classList.toggle('hidden', !loading);
  }

  function showMessage(type: 'success' | 'error', message: string) {
    formStatus.classList.remove('hidden');
    formSuccess.classList.toggle('hidden', type !== 'success');
    formError.classList.toggle('hidden', type !== 'error');

    const messageEl = type === 'success'
      ? formSuccess.querySelector('p')
      : formError.querySelector('p');
    if (messageEl) {
      messageEl.textContent = message;
    }
  }

  function hideMessage() {
    formStatus.classList.add('hidden');
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessage();
    setLoading(true);

    const formData = new FormData(form);
    const data: Record<string, string> = {};
    formData.forEach((value, key) => {
      data[key] = value.toString();
    });

    // Add source page
    data.source_page = window.location.pathname;

    try {
      const response = await fetch('/api/contact/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        showMessage('success', result.data?.message || '感謝您的來信！');
        form.reset();
      } else {
        showMessage('error', result.error?.message || '提交失敗，請稍後再試');
      }
    } catch (error) {
      console.error('Form submission error:', error);
      showMessage('error', '網路錯誤，請稍後再試');
    } finally {
      setLoading(false);
    }
  });
</script>
