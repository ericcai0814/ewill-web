---
import { getAssetById } from '../utils/content';

export interface TimelineEvent {
  id: string;
  year: string;
  title: string;
  description?: string;
  image_id?: string;
}

export interface Props {
  label?: string;
  title: string;
  description?: string;
  events: TimelineEvent[];
  layout?: 'vertical' | 'horizontal';
}

const {
  label,
  title,
  description,
  events,
  layout = 'vertical'
} = Astro.props;

// 解析所有 event 的圖片
const eventsWithImages = await Promise.all(
  events.map(async (event) => {
    let image = null;
    if (event.image_id) {
      const asset = await getAssetById(event.image_id);
      if (asset) {
        image = {
          src: asset.variants.desktop,
          alt: asset.alt
        };
      }
    }
    return { ...event, image };
  })
);

const isHorizontal = layout === 'horizontal';
---

<!-- Vitesse Style: Clean timeline, no gradient markers -->
<section class="py-12 md:py-16 bg-[var(--bg-secondary)]">
  <div class="container-wide">
    <!-- Section Header -->
    <header class="text-center mb-12">
      {label && (
        <span class="inline-block text-xs font-medium text-[var(--accent)] uppercase tracking-wider mb-3">
          {label}
        </span>
      )}
      <h2 class="text-2xl md:text-3xl font-semibold text-[var(--text-primary)] mb-3">
        {title}
      </h2>
      {description && (
        <p class="text-[var(--text-secondary)] max-w-2xl mx-auto">
          {description}
        </p>
      )}
    </header>

    <!-- Timeline -->
    <div class:list={[
      'relative',
      isHorizontal
        ? 'flex overflow-x-auto gap-6 py-5 max-w-none'
        : 'max-w-3xl mx-auto'
    ]}>
      <!-- Timeline Line -->
      <div
        class:list={[
          'absolute bg-[var(--accent)]',
          isHorizontal
            ? 'top-10 left-0 right-0 h-0.5 w-auto'
            : 'left-1/2 md:left-10 top-0 bottom-0 w-0.5 -translate-x-1/2 md:translate-x-0'
        ]}
        aria-hidden="true"
      ></div>

      {eventsWithImages.map((event, index) => (
        <article
          class:list={[
            'relative',
            isHorizontal
              ? 'flex flex-col shrink-0 w-[280px]'
              : [
                  'flex mb-10 last:mb-0 flex-col md:flex-row md:pl-24',
                ]
          ]}
          data-event-id={event.id}
        >
          <!-- Marker -->
          <div class:list={[
            isHorizontal
              ? 'relative mb-6'
              : 'absolute left-1/2 md:left-10 top-0 -translate-x-1/2 md:translate-x-[-50%] z-[2]'
          ]}>
            <span class:list={[
              'flex items-center justify-center bg-[var(--accent)] text-white font-semibold rounded-full',
              isHorizontal
                ? 'w-14 h-14 text-sm'
                : 'w-16 h-16 md:w-14 md:h-14 text-sm'
            ]}>
              {event.year}
            </span>
          </div>

          <!-- Content -->
          <div class="w-full card-filled overflow-hidden mt-20 md:mt-0">
            {event.image && (
              <div class="aspect-video overflow-hidden bg-[var(--bg-tertiary)]">
                <img
                  src={event.image.src}
                  alt={event.image.alt}
                  class="w-full h-full object-cover"
                  loading="lazy"
                  decoding="async"
                />
              </div>
            )}
            <div class="p-5">
              <h3 class="text-base font-semibold text-[var(--text-primary)] mb-2">
                {event.title}
              </h3>
              {event.description && (
                <p class="text-sm text-[var(--text-secondary)] m-0">
                  {event.description}
                </p>
              )}
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>
</section>
