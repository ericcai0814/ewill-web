---
import { getAssetById } from '../utils/content';

export interface TimelineEvent {
  id: string;
  year: string;
  title: string;
  description?: string;
  image_id?: string;
}

export interface Props {
  label?: string;
  title: string;
  description?: string;
  events: TimelineEvent[];
  layout?: 'vertical' | 'horizontal';
}

const {
  label,
  title,
  description,
  events,
  layout = 'vertical'
} = Astro.props;

// 解析所有 event 的圖片
const eventsWithImages = await Promise.all(
  events.map(async (event) => {
    let image = null;
    if (event.image_id) {
      const asset = await getAssetById(event.image_id);
      if (asset) {
        image = {
          src: asset.variants.desktop,
          alt: asset.alt
        };
      }
    }
    return { ...event, image };
  })
);

const isHorizontal = layout === 'horizontal';
---

<section class="py-20 max-lg:py-[60px] bg-secondary dark:bg-dark-800">
  <div class="max-w-[1280px] mx-auto px-6 max-lg:px-4">
    <!-- Section Header -->
    <header class="text-center mb-[60px] max-lg:mb-10">
      {label && (
        <span class="inline-block text-sm font-semibold text-brand uppercase tracking-[0.1em] mb-3">
          {label}
        </span>
      )}
      <h2 class="text-4xl max-lg:text-[28px] font-bold text-primary dark:text-white mb-4 leading-tight">
        {title}
      </h2>
      {description && (
        <p class="text-lg text-secondary dark:text-gray-300 m-0 max-w-[600px] mx-auto leading-relaxed">
          {description}
        </p>
      )}
    </header>

    <!-- Timeline -->
    <div class:list={[
      'relative',
      isHorizontal
        ? 'flex overflow-x-auto gap-6 py-5 max-w-none'
        : 'max-w-[900px] mx-auto'
    ]}>
      <!-- Timeline Line -->
      <div
        class:list={[
          'absolute bg-gradient-to-b from-brand to-brand-hover',
          isHorizontal
            ? 'top-10 left-0 right-0 h-0.5 w-auto'
            : 'left-1/2 max-lg:left-10 top-0 bottom-0 w-0.5 -translate-x-1/2 max-lg:translate-x-0'
        ]}
        aria-hidden="true"
      ></div>

      {eventsWithImages.map((event, index) => (
        <article
          class:list={[
            'relative',
            isHorizontal
              ? 'flex flex-col shrink-0 w-[280px]'
              : [
                  'flex mb-12 last:mb-0 max-lg:flex-col max-lg:pl-[100px]',
                  index % 2 === 0
                    ? 'flex-row pr-[calc(50%+40px)] max-lg:pr-0'
                    : 'flex-row-reverse pl-[calc(50%+40px)] max-lg:pl-[100px]'
                ]
          ]}
          data-event-id={event.id}
        >
          <!-- Marker -->
          <div class:list={[
            isHorizontal
              ? 'relative mb-6'
              : 'absolute left-1/2 max-lg:left-10 top-0 -translate-x-1/2 max-lg:translate-x-[-50%] z-[2]'
          ]}>
            <span class:list={[
              'flex items-center justify-center bg-gradient-to-br from-brand to-brand-hover text-white font-bold rounded-full shadow-[0_4px_20px_rgba(63,134,150,0.3)]',
              isHorizontal
                ? 'w-16 h-16 text-base'
                : 'w-20 h-20 max-lg:w-[60px] max-lg:h-[60px] text-lg max-lg:text-sm'
            ]}>
              {event.year}
            </span>
          </div>

          <!-- Content -->
          <div class="w-full bg-primary dark:bg-dark-700 rounded-xl overflow-hidden shadow-card
                      transition-all duration-300 hover:-translate-y-1 hover:shadow-card-hover">
            {event.image && (
              <div class="aspect-video overflow-hidden bg-secondary dark:bg-dark-600">
                <img
                  src={event.image.src}
                  alt={event.image.alt}
                  class="w-full h-full object-cover"
                  loading="lazy"
                  decoding="async"
                />
              </div>
            )}
            <div class="p-6 max-lg:p-5">
              <h3 class="text-xl max-lg:text-lg font-semibold text-primary dark:text-white mb-2 leading-relaxed">
                {event.title}
              </h3>
              {event.description && (
                <p class="text-sm text-secondary dark:text-gray-400 m-0 leading-relaxed">
                  {event.description}
                </p>
              )}
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>
</section>
