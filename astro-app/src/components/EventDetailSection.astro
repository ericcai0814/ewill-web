---
/**
 * EventDetailSection.astro
 *
 * 活動詳情內容區塊組件
 *
 * 設計要點：
 * - 顯示活動完整內容（Markdown 渲染）
 * - 活動資訊（日期、分類）
 * - Gallery 圖片區塊（如有）
 */
import { marked } from 'marked';
import { getAssetById } from '../utils/content';
import GallerySection from './GallerySection.astro';
import type { EventCategory } from '@ewill/shared';

export interface Props {
  /** 標題 */
  title: string;
  /** 摘要 */
  summary?: string;
  /** 分類 */
  category: EventCategory;
  /** 活動日期（ISO 字串） */
  event_date: string;
  /** 結束日期（ISO 字串） */
  end_date?: string;
  /** Markdown 內容 */
  content: string;
  /** Hero 圖片 ID */
  hero_image_id?: string;
  /** Gallery 圖片 IDs */
  gallery?: string[];
}

const {
  title,
  summary,
  category,
  event_date,
  end_date,
  content,
  hero_image_id,
  gallery,
} = Astro.props;

// 分類標籤對應
const CATEGORY_LABELS: Record<EventCategory, string> = {
  seminar: '研討會',
  webinar: '線上講座',
  press_release: '新聞發布',
  exhibition: '展覽',
  other: '其他活動',
};

// 格式化日期
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

function formatDateRange(start: string, end?: string): string {
  if (!end) return formatDate(start);
  return `${formatDate(start)} - ${formatDate(end)}`;
}

const categoryLabel = CATEGORY_LABELS[category] || '活動新聞';
const dateRange = formatDateRange(event_date, end_date);

// 解析 Hero 圖片
const heroAsset = hero_image_id ? await getAssetById(hero_image_id) : null;

// 解析 Gallery 圖片
const galleryItems = gallery
  ? await Promise.all(
      gallery.map(async (imageId, index) => {
        const asset = await getAssetById(imageId);
        return asset
          ? {
              id: `gallery-${index}`,
              image_id: imageId,
              title: asset.alt,
            }
          : null;
      })
    ).then((items) => items.filter((item): item is NonNullable<typeof item> => item !== null))
  : [];

// 渲染 Markdown
const htmlContent = marked.parse(content, { async: false });
---

<article class="event-detail">
  {/* Hero Image */}
  {heroAsset && (
    <section class="event-hero">
      <picture class="block w-full h-full">
        <source media="(min-width: 768px)" srcset={heroAsset.variants.desktop} />
        <source media="(max-width: 767px)" srcset={heroAsset.variants.mobile} />
        <img
          src={heroAsset.variants.desktop}
          alt={heroAsset.alt}
          class="event-hero-image"
          loading="eager"
          decoding="async"
        />
      </picture>
      <div class="event-hero-overlay"></div>
    </section>
  )}

  {/* Event Header */}
  <header class="event-header">
    <div class="container">
      <div class="event-meta">
        <span class="event-category">{categoryLabel}</span>
        <time class="event-date" datetime={event_date}>{dateRange}</time>
      </div>
      <h1 class="event-title">{title}</h1>
      {summary && (
        <p class="event-summary">{summary}</p>
      )}
    </div>
  </header>

  {/* Event Content */}
  <section class="event-content">
    <div class="container">
      <div class="prose" set:html={htmlContent} />
    </div>
  </section>

  {/* Gallery Section */}
  {galleryItems.length > 0 && (
    <GallerySection
      title="活動照片"
      columns={3}
      gap="medium"
      lightbox={true}
      images={galleryItems}
    />
  )}
</article>

<style>
  .event-detail {
    min-height: 100vh;
  }

  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* Hero Section */
  .event-hero {
    position: relative;
    width: 100%;
    height: 50vw;
    max-height: 500px;
    min-height: 280px;
    overflow: hidden;
    background: var(--bg-tertiary);
  }

  .event-hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .event-hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.3) 100%);
    pointer-events: none;
  }

  /* Event Header */
  .event-header {
    padding: 48px 0 32px;
    text-align: center;
  }

  .event-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .event-category {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--bg-primary);
    background: var(--accent);
    padding: 6px 14px;
    border-radius: 4px;
  }

  .event-date {
    font-size: 14px;
    color: var(--text-tertiary);
  }

  .event-title {
    font-size: clamp(28px, 5vw, 42px);
    font-weight: 600;
    line-height: 1.2;
    color: var(--text-primary);
    margin: 0 0 16px;
  }

  .event-summary {
    font-size: 17px;
    line-height: 1.6;
    color: var(--text-secondary);
    max-width: 700px;
    margin: 0 auto;
  }

  /* Event Content */
  .event-content {
    padding: 0 0 64px;
  }

  /* Prose styling for Markdown content */
  .prose {
    font-size: 17px;
    line-height: 1.8;
    color: var(--text-secondary);
  }

  .prose :global(h1),
  .prose :global(h2),
  .prose :global(h3),
  .prose :global(h4),
  .prose :global(h5),
  .prose :global(h6) {
    color: var(--text-primary);
    font-weight: 600;
    line-height: 1.3;
    margin-top: 2em;
    margin-bottom: 0.75em;
  }

  .prose :global(h2) {
    font-size: 1.5em;
  }

  .prose :global(h3) {
    font-size: 1.25em;
  }

  .prose :global(p) {
    margin-bottom: 1.25em;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: 1.25em;
    padding-left: 1.5em;
  }

  .prose :global(li) {
    margin-bottom: 0.5em;
  }

  .prose :global(a) {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  .prose :global(a:hover) {
    color: var(--accent-hover, var(--accent));
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin: 2em 0;
  }

  .prose :global(blockquote) {
    border-left: 4px solid var(--accent);
    padding-left: 1em;
    margin: 1.5em 0;
    font-style: italic;
    color: var(--text-tertiary);
  }

  .prose :global(code) {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
  }

  .prose :global(pre) {
    background: var(--bg-tertiary);
    padding: 1em;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1.5em 0;
  }

  .prose :global(pre code) {
    background: none;
    padding: 0;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 2em 0;
  }

  /* Dark Mode */
  :global(.dark) .event-hero-overlay {
    background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.5) 100%);
  }
</style>
