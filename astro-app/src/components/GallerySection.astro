---
import { getAssetById } from '../utils/content';

export interface GalleryImage {
  id: string;
  image_id: string;
  title?: string;
  caption?: string;
}

export interface Props {
  label?: string;
  title?: string;
  description?: string;
  columns?: 2 | 3 | 4;
  gap?: 'small' | 'medium' | 'large';
  images: GalleryImage[];
  lightbox?: boolean;
}

const {
  label,
  title,
  description,
  columns = 3,
  gap = 'medium',
  images,
  lightbox = true
} = Astro.props;

// 解析所有圖片
const imagesWithAssets = await Promise.all(
  images.map(async (item) => {
    const asset = await getAssetById(item.image_id);
    return {
      ...item,
      image: asset ? {
        desktop: asset.variants.desktop,
        mobile: asset.variants.mobile,
        alt: asset.alt
      } : null
    };
  })
);

// Grid columns class
const gridCols = {
  2: 'md:grid-cols-2',
  3: 'md:grid-cols-2 lg:grid-cols-3',
  4: 'grid-cols-2 md:grid-cols-3 lg:grid-cols-4'
}[columns];

// Gap class
const gapClass = {
  small: 'gap-3',
  medium: 'gap-6',
  large: 'gap-8'
}[gap];
---

<section class="py-20 max-lg:py-[60px]">
  <div class="max-w-[1280px] mx-auto px-6 max-lg:px-4">
    <!-- Section Header -->
    {(label || title || description) && (
      <header class="text-center mb-12 max-lg:mb-8">
        {label && (
          <span class="inline-block text-sm font-semibold text-brand uppercase tracking-[0.1em] mb-3">
            {label}
          </span>
        )}
        {title && (
          <h2 class="text-4xl max-lg:text-[28px] font-bold text-primary dark:text-white mb-4 leading-tight">
            {title}
          </h2>
        )}
        {description && (
          <p class="text-lg text-secondary dark:text-gray-300 m-0 max-w-[600px] mx-auto leading-relaxed">
            {description}
          </p>
        )}
      </header>
    )}

    <!-- Gallery Grid -->
    <div class:list={['grid grid-cols-1', gridCols, gapClass]} data-lightbox={lightbox}>
      {imagesWithAssets.map((item) => item.image && (
        <figure class="m-0" data-gallery-id={item.id}>
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-secondary dark:bg-dark-700 group">
            <picture class="block w-full h-full">
              <source media="(min-width: 1024px)" srcset={item.image.desktop} />
              <source media="(max-width: 1023px)" srcset={item.image.mobile} />
              <img
                src={item.image.desktop}
                alt={item.image.alt}
                class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
                decoding="async"
              />
            </picture>
            {lightbox && (
              <button
                class="gallery-zoom absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-[0.8] opacity-0
                       w-14 h-14 max-lg:w-12 max-lg:h-12 flex items-center justify-center
                       bg-white/95 border-none rounded-full cursor-pointer text-brand
                       transition-all duration-300 shadow-popup
                       group-hover:opacity-100 group-hover:scale-100
                       hover:bg-brand hover:text-white"
                data-src={item.image.desktop}
                data-alt={item.image.alt}
                aria-label="放大檢視"
              >
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="M21 21l-4.35-4.35"/>
                  <path d="M11 8v6M8 11h6"/>
                </svg>
              </button>
            )}
          </div>
          {(item.title || item.caption) && (
            <figcaption class="py-4 text-center">
              {item.title && <h3 class="text-base font-semibold text-primary dark:text-white mb-1">{item.title}</h3>}
              {item.caption && <p class="text-sm text-secondary dark:text-gray-400 m-0">{item.caption}</p>}
            </figcaption>
          )}
        </figure>
      ))}
    </div>
  </div>
</section>

<!-- Lightbox Modal -->
{lightbox && (
  <div
    class="lightbox hidden fixed inset-0 z-[3000] items-center justify-center"
    id="gallery-lightbox"
    aria-hidden="true"
    role="dialog"
    aria-modal="true"
  >
    <div class="absolute inset-0 bg-black/90"></div>
    <div class="relative max-w-[90vw] max-h-[90vh]">
      <button
        class="lightbox-close absolute -top-12 right-0 w-10 h-10 flex items-center justify-center
               bg-transparent border-none text-white cursor-pointer transition-transform hover:scale-110"
        aria-label="關閉"
      >
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      <img class="lightbox-image block max-w-full max-h-[85vh] rounded-lg shadow-popup" src="" alt="" />
    </div>
  </div>
)}

<script>
  function initGalleryLightbox() {
    const lightbox = document.getElementById('gallery-lightbox');
    const lightboxImage = lightbox?.querySelector('.lightbox-image') as HTMLImageElement;
    const closeBtn = lightbox?.querySelector('.lightbox-close');
    const overlay = lightbox?.querySelector('.absolute');

    if (!lightbox || !lightboxImage) return;

    // 綁定所有放大按鈕
    document.querySelectorAll('.gallery-zoom').forEach((btn) => {
      btn.addEventListener('click', () => {
        const src = btn.getAttribute('data-src');
        const alt = btn.getAttribute('data-alt');
        if (src) {
          lightboxImage.src = src;
          lightboxImage.alt = alt || '';
          lightbox.classList.remove('hidden');
          lightbox.classList.add('flex');
          document.body.style.overflow = 'hidden';
        }
      });
    });

    function closeLightbox() {
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
      document.body.style.overflow = '';
      lightboxImage.src = '';
    }

    closeBtn?.addEventListener('click', closeLightbox);
    overlay?.addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !lightbox.classList.contains('hidden')) {
        closeLightbox();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGalleryLightbox);
  } else {
    initGalleryLightbox();
  }
</script>
