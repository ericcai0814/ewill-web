---
import { getAssetById } from '../utils/content';

export interface ShowcaseFeature {
  id: string;
  image_id: string;
  title: string;
  description: string;
  bullets?: string[];
}

export interface Props {
  label?: string;
  title?: string;
  layout?: 'alternating' | 'image-left' | 'image-right';
  features: ShowcaseFeature[];
}

const {
  label,
  title,
  layout = 'alternating',
  features
} = Astro.props;

// 解析所有 feature 的圖片
const featuresWithImages = await Promise.all(
  features.map(async (feature) => {
    const asset = await getAssetById(feature.image_id);
    return {
      ...feature,
      image: asset ? {
        desktop: asset.variants.desktop,
        mobile: asset.variants.mobile,
        alt: asset.alt
      } : null
    };
  })
);
---

<section class="py-20 max-lg:py-[60px]">
  <div class="max-w-[1280px] mx-auto px-6 max-lg:px-4">
    <!-- Section Header -->
    {(label || title) && (
      <header class="text-center mb-[60px] max-lg:mb-10">
        {label && (
          <span class="inline-block text-sm font-semibold text-brand uppercase tracking-[0.1em] mb-3">
            {label}
          </span>
        )}
        {title && (
          <h2 class="text-4xl max-lg:text-[28px] font-bold text-primary dark:text-white m-0 leading-tight">
            {title}
          </h2>
        )}
      </header>
    )}

    <!-- Features -->
    <div class="flex flex-col gap-20 max-lg:gap-12">
      {featuresWithImages.map((feature, index) => {
        // 判斷圖片位置
        const isImageLeft = layout === 'image-left' ||
          (layout === 'alternating' && index % 2 === 0);

        return (
          <article
            class:list={[
              'grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-[60px] items-center',
              !isImageLeft && 'lg:[direction:rtl] lg:[&>*]:[direction:ltr]'
            ]}
            data-feature-id={feature.id}
          >
            {feature.image && (
              <div class="relative rounded-2xl overflow-hidden aspect-[4/3] bg-secondary dark:bg-dark-800 shadow-[0_20px_60px_rgba(0,0,0,0.1)]">
                <picture class="block w-full h-full">
                  <source media="(min-width: 1024px)" srcset={feature.image.desktop} />
                  <source media="(max-width: 1023px)" srcset={feature.image.mobile} />
                  <img
                    src={feature.image.desktop}
                    alt={feature.image.alt}
                    class="w-full h-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                </picture>
              </div>
            )}
            <div class="lg:py-5">
              <h3 class="text-[28px] max-lg:text-2xl font-bold text-primary dark:text-white mb-4 leading-tight">
                {feature.title}
              </h3>
              <p class="text-base max-lg:text-[15px] text-secondary dark:text-gray-300 mb-6 leading-relaxed">
                {feature.description}
              </p>
              {feature.bullets && feature.bullets.length > 0 && (
                <ul class="list-none m-0 p-0 flex flex-col gap-3">
                  {feature.bullets.map((bullet) => (
                    <li class="flex items-start gap-3 text-[15px] text-primary dark:text-gray-200 leading-normal">
                      <span class="shrink-0 w-1.5 h-1.5 mt-2 bg-brand rounded-full"></span>
                      {bullet}
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </article>
        );
      })}
    </div>
  </div>
</section>
