---
import { getPageContent, getAssetById } from '../utils/content';
import type { NavItem } from '../types';

/**
 * Header
 * 全站共用頁首導航元件
 */
export interface Props {
  // 目前從 content 讀取，保留供未來擴充
}

interface HeaderNavItem extends NavItem {
  /** 是否為 CTA 按鈕樣式 */
  is_cta?: boolean;
}

// 讀取 header.json
const headerData = await getPageContent('header');

// 從 asset-manifest 取得 logo 圖片路徑
const logoAsset = await getAssetById('logo');
const logoSrc = logoAsset?.normalized_path || '/assets/logo.png';
const logo = {
  src: logoSrc,
  alt: headerData?.logo?.alt || '鎰威科技 EWILL Technology',
  link: headerData?.logo?.link || '/'
};

const navigation: HeaderNavItem[] = headerData?.navigation || [];
---

<!-- Vitesse Style Header: Clean, minimal, no glassmorphism -->
<header
  class="fixed top-0 left-0 right-0 h-16 bg-[var(--bg-primary)] border-b border-[var(--border-color)] z-[1000] transition-all duration-200"
  id="main-header"
>
  <div class="container-wide h-full flex items-center justify-between">
    <!-- Logo -->
    <a href={logo.link} class="flex items-center">
      <img
        src={logo.src}
        alt={logo.alt}
        width="140"
        height="32"
        class="h-8 w-auto logo-adaptive"
      />
    </a>

    <!-- Desktop Navigation -->
    <nav class="hidden md:flex items-center gap-1" aria-label="主要導覽列">
      {navigation.map((item) => (
        <div class="relative group">
          {item.is_cta ? (
            <a
              href={item.url}
              class="btn btn-primary text-sm"
            >
              {item.text}
            </a>
          ) : (
            <a
              href={item.url}
              class="px-3 py-2 text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--accent)] transition-colors"
            >
              {item.text}
            </a>
          )}
          {item.children && item.children.length > 0 && (
            <div class="hidden group-hover:block absolute top-full left-0 pt-2">
              <ul class="bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-md min-w-[180px] py-1 list-none m-0">
                {item.children.map((child) => (
                  <li class="relative group/child">
                    <a
                      href={child.url}
                      class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:text-[var(--accent)] hover:bg-[var(--bg-secondary)] transition-colors"
                    >
                      {child.text}
                    </a>
                    {child.children && child.children.length > 0 && (
                      <div class="hidden group-hover/child:block absolute top-0 left-full pl-1">
                        <ul class="bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-md min-w-[160px] py-1 list-none m-0">
                          {child.children.map((nested) => (
                            <li>
                              <a
                                href={nested.url}
                                class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:text-[var(--accent)] hover:bg-[var(--bg-secondary)] transition-colors"
                              >
                                {nested.text}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      ))}
    </nav>

    <!-- Actions: Dark Mode + Mobile Menu -->
    <div class="flex items-center gap-1">
      <!-- Dark Mode Toggle -->
      <button
        class="dark-mode-toggle"
        onclick="window.toggleDarkMode()"
        aria-label="切換深色模式"
      >
        <!-- Sun Icon (Light Mode) -->
        <svg class="dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <!-- Moon Icon (Dark Mode) -->
        <svg class="hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>

      <!-- Mobile Menu Toggle -->
      <button
        class="hidden max-md:flex items-center justify-center w-10 h-10 rounded-md
               text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)] hover:text-[var(--text-primary)]
               transition-colors"
        id="mobile-menu-toggle"
        aria-label="開啟選單"
        aria-expanded="false"
      >
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu (Vitesse Style: Slide from right) -->
  <div class="mobile-menu hidden fixed inset-0 z-[1001]" id="mobile-menu" aria-hidden="true">
    <div class="absolute inset-0 bg-black/20" id="mobile-overlay"></div>
    <nav class="absolute top-0 right-0 w-[280px] h-full bg-[var(--bg-primary)] border-l border-[var(--border-color)] overflow-y-auto">
      <!-- Close Button -->
      <div class="flex justify-end p-4">
        <button
          class="dark-mode-toggle"
          id="mobile-menu-close"
          aria-label="關閉選單"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Navigation Links -->
      <ul class="list-none m-0 p-4 pt-0">
        {navigation.map((item) => (
          <li class="border-b border-[var(--border-color-light)]">
            <a
              href={item.url}
              class="block py-3 text-sm font-medium text-[var(--text-primary)] hover:text-[var(--accent)] transition-colors"
            >
              {item.text}
            </a>
            {item.children && item.children.length > 0 && (
              <ul class="list-none m-0 pb-3 pl-4">
                {item.children.map((child) => (
                  <li>
                    <a
                      href={child.url}
                      class="block py-2 text-sm text-[var(--text-secondary)] hover:text-[var(--accent)] transition-colors"
                    >
                      {child.text}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>
    </nav>
  </div>
</header>

<script>
  // Mobile Menu Toggle
  const menuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuClose = document.getElementById('mobile-menu-close');
  const overlay = document.getElementById('mobile-overlay');

  function openMenu() {
    mobileMenu?.classList.remove('hidden');
    menuToggle?.setAttribute('aria-expanded', 'true');
    mobileMenu?.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function closeMenu() {
    mobileMenu?.classList.add('hidden');
    menuToggle?.setAttribute('aria-expanded', 'false');
    mobileMenu?.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  menuToggle?.addEventListener('click', openMenu);
  menuClose?.addEventListener('click', closeMenu);
  overlay?.addEventListener('click', closeMenu);
</script>
